<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATeR - GitHub Analysis Tool for Relationships</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            /* Custom Color Theme - No Gradients */
            --color-primary: #2C3639;      /* Dark Blue-Gray */
            --color-secondary: #3F4E4F;    /* Medium Blue-Gray */
            --color-accent: #A27B5C;       /* Warm Brown */
            --color-light: #DCD7C9;        /* Light Cream */
            
            /* Semantic Colors */
            --color-success: #4ade80;
            --color-warning: #fbbf24;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            /* Text Colors */
            --text-primary: var(--color-primary);
            --text-secondary: var(--color-secondary);
            --text-light: #ffffff;
            --text-muted: #6b7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: var(--color-light);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            background-color: var(--color-primary);
            color: var(--text-light);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(44, 54, 57, 0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 200px;
            height: 200px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(220,215,201,0.1)" stroke-width="2"/><circle cx="50" cy="50" r="25" fill="none" stroke="rgba(220,215,201,0.1)" stroke-width="1.5"/><circle cx="50" cy="50" r="10" fill="rgba(220,215,201,0.1)"/></svg>') no-repeat center;
            background-size: contain;
            opacity: 0.3;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 .logo-icon {
            background-color: var(--color-accent);
            padding: 12px;
            border-radius: 12px;
            font-size: 2rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .auth-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid rgba(220, 215, 201, 0.2);
        }
        
        .auth-login-card {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            border: 2px solid var(--color-accent);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(44, 54, 57, 0.3);
            transition: all 0.3s ease;
        }
        
        .auth-login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 45px rgba(44, 54, 57, 0.4);
        }
        
        .auth-login-card h2 {
            color: var(--color-light);
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .auth-login-card p {
            color: rgba(220, 215, 201, 0.9);
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .auth-icon {
            font-size: 4rem;
            color: var(--color-accent);
            margin-bottom: 25px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .progress-simulation {
            background: var(--color-light);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid var(--color-accent);
            box-shadow: 0 8px 25px rgba(44, 54, 57, 0.15);
        }
        
        .progress-step {
            display: none; /* Initially hidden */
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.4s ease;
            transform: translateX(-20px);
            opacity: 0;
        }
        
        .progress-step.visible {
            display: flex;
            transform: translateX(0);
            opacity: 1;
            border-color: rgba(162, 123, 92, 0.2);
            background: rgba(220, 215, 201, 0.3);
        }
        
        .progress-step.active {
            background: linear-gradient(135deg, rgba(162, 123, 92, 0.15) 0%, rgba(162, 123, 92, 0.25) 100%);
            border-color: var(--color-accent);
            box-shadow: 0 4px 15px rgba(162, 123, 92, 0.3);
            transform: scale(1.02);
        }
        
        .progress-step.completed {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.25) 100%);
            border-color: #4CAF50;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .progress-step.completed .progress-title {
            color: #2E7D32;
        }
        
        .progress-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .progress-icon.pending {
            background: rgba(220, 215, 201, 0.3);
            color: var(--text-muted);
        }
        
        .progress-icon.active {
            background: var(--color-accent);
            color: white;
            animation: spin 2s linear infinite;
        }
        
        .progress-icon.completed {
            background: #4CAF50;
            color: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-text {
            flex: 1;
        }
        
        .progress-title {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .progress-description {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .knowledge-preview {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
            display: none;
        }
        
        .knowledge-preview.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .knowledge-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .knowledge-stat {
            background: var(--color-primary);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .mini-graph {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .graph-node {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color-accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .graph-edge {
            position: absolute;
            height: 2px;
            background: rgba(162, 123, 92, 0.6);
            transform-origin: left center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--color-accent);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .user-details h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .user-details p {
            margin: 0;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        /* Button Styles */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background-color: var(--color-accent);
            color: var(--text-light);
        }

        .btn-primary:hover {
            background-color: #8d6a4f;
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--text-light);
        }

        .btn-secondary:hover {
            background-color: #354142;
        }

        .btn-danger {
            background-color: var(--color-error);
            color: var(--text-light);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .btn-success {
            background-color: var(--color-accent);
            color: var(--text-light);
        }

        .btn-success:hover {
            background-color: #8d6a4f;
        }

        /* Card Styles */
        .card {
            background-color: #ffffff;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(44, 54, 57, 0.08);
            border: 1px solid rgba(44, 54, 57, 0.05);
            position: relative;
        }

        .card h2 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h2 i {
            color: var(--color-accent);
            font-size: 1.5rem;
        }

        /* Form Styles */
        .repo-form {
            display: grid;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: #ffffff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(162, 123, 92, 0.1);
        }

        .checkbox-label {
            display: flex !important;
            flex-direction: row !important;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 500 !important;
            color: var(--text-primary) !important;
            padding: 12px;
            background-color: #f9fafb;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .checkbox-label:hover {
            background-color: #f3f4f6;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.3);
            accent-color: var(--color-accent);
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-idle {
            background-color: #f3f4f6;
            color: var(--text-muted);
        }

        .status-analyzing {
            background-color: #fef3c7;
            color: #d97706;
            animation: pulse 2s infinite;
        }

        .status-completed {
            background-color: #d1fae5;
            color: #059669;
        }

        .status-error {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .status-behind {
            background-color: #dbeafe;
            color: #2563eb;
            animation: blink 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.8; }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .stat-card {
            background-color: var(--color-secondary);
            color: var(--text-light);
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100px;
            height: 100px;
            background: rgba(220, 215, 201, 0.1);
            border-radius: 50%;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Repository Info */
        .repo-info {
            background-color: var(--color-accent);
            color: var(--text-light);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .repo-info::before {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="rgba(255,255,255,0.1)"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>') no-repeat center;
            background-size: contain;
            opacity: 0.3;
        }

        .repo-info h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .repo-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .repo-meta > div {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert {
            padding: 18px 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border-left-color: var(--color-success);
        }

        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border-left-color: var(--color-error);
        }

        .alert-info {
            background-color: #dbeafe;
            color: #1e40af;
            border-left-color: var(--color-info);
        }

        .alert-warning {
            background-color: #fef3c7;
            color: #92400e;
            border-left-color: var(--color-warning);
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Enhanced Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background-color: #ffffff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(44, 54, 57, 0.05);
        }

        .data-table thead {
            background-color: var(--color-primary);
            color: var(--text-light);
        }

        .data-table th,
        .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            word-wrap: break-word;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table th {
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .data-table tbody tr:hover {
            background-color: rgba(162, 123, 92, 0.1);
        }
        
        .data-table tbody tr:nth-child(even) {
            background-color: rgba(248, 249, 250, 0.8);
        }
        
        .data-table tbody tr:nth-child(even):hover {
            background-color: rgba(162, 123, 92, 0.15);
        }
        
        .scrollable-table {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border-radius: 12px;
            border: 2px solid var(--color-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .scrollable-table::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .scrollable-table::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .scrollable-table::-webkit-scrollbar-thumb {
            background: var(--color-accent);
            border-radius: 4px;
        }
        
        .scrollable-table::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }
        
        /* Knowledge Graph Visualization Styles */
        .graph-controls label {
            font-weight: 600;
            color: var(--color-primary);
            margin-right: 8px;
        }
        
        .graph-controls select {
            padding: 6px 12px;
            border: 1px solid var(--color-light);
            border-radius: 6px;
            background: white;
            color: var(--color-primary);
            font-size: 0.9rem;
        }
        
        .legend-section {
            margin-bottom: 15px;
        }
        
        .legend-section h5 {
            margin: 0 0 8px 0;
            color: var(--color-primary);
            font-size: 0.95rem;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: rgba(220, 215, 201, 0.5);
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        .node-details {
            animation: slideUp 0.3s ease;
        }
        
        .node-details h4 {
            margin: 0 0 15px 0;
            color: var(--color-primary);
        }
        
        .node-detail-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
        }
        
        .node-detail-label {
            font-weight: 600;
            color: var(--color-primary);
            margin-right: 8px;
        }
        
        /* Graph SVG Styles */
        .graph-node {
            cursor: pointer;
            stroke-width: 2px;
            transition: all 0.2s ease;
        }
        
        .graph-node:hover {
            stroke-width: 3px;
            filter: brightness(1.1);
        }
        
        .graph-node.selected {
            stroke-width: 4px;
            stroke: var(--color-accent);
        }
        
        .graph-link {
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            fill: none;
        }
        
        .graph-link.highlighted {
            stroke-opacity: 1;
            stroke-width: 3px;
        }
        
        .graph-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10px;
            fill: var(--color-primary);
            text-anchor: middle;
            pointer-events: none;
            user-select: none;
        }
        
        .graph-text.large {
            font-size: 12px;
            font-weight: 600;
        }

        /* Auto-refresh indicator */
        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--color-primary);
            color: var(--text-light);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(44, 54, 57, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh.updating {
            background-color: var(--color-accent);
            animation: pulse 1s infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2rem;
                flex-direction: column;
                text-align: center;
            }
            
            .auth-section {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .actions {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 15px;
            }
            
            .repo-meta {
                grid-template-columns: 1fr;
            }
        }

        /* Enhanced animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Auto-refresh indicator -->
    <div id="auto-refresh-indicator" class="auto-refresh hidden">
        <i class="fas fa-sync-alt"></i>
        <span>Auto-updating...</span>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header fade-in">
            <div class="header-content">
                <h1>
                    <span class="logo-icon">
                        <i class="fas fa-project-diagram"></i>
                    </span>
                    GATeR
                </h1>
                <p><i class="fas fa-code-branch"></i> GitHub Analysis Tool for Relationships - Analyze code repositories and build knowledge graphs</p>
            
            <div class="auth-section">
                {% if authenticated %}
                    <div class="user-info">
                        <img src="{{ get_user().avatar_url }}" alt="Avatar" class="user-avatar">
                            <div class="user-details">
                                <h3>{{ get_user().name or get_user().login }}</h3>
                                <p><i class="fab fa-github"></i> {{ get_user().login }}</p>
                        </div>
                    </div>
                        <a href="/auth/logout" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                {% else %}
                        <div class="text-center">
                            <p style="margin-bottom: 15px; opacity: 0.9;">Connect your GitHub account to analyze repositories</p>
                            <a href="/auth/login" class="btn btn-primary">
                                <i class="fab fa-github"></i> Login with GitHub
                            </a>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>

        {% if authenticated %}
            <!-- Repository Management -->
            <div class="card slide-up">
                <h2>
                    <i class="fas fa-folder-open"></i>
                    Repository Management
                </h2>
                
                <!-- Current Repository Info -->
                {% if get_app_state().current_repo %}
                    <div class="repo-info">
                        <h3><i class="fab fa-github"></i> {{ get_app_state().current_repo.owner }}/{{ get_app_state().current_repo.name }}</h3>
                        <div class="repo-meta">
                            <div>
                                <strong><i class="fas fa-calendar-plus"></i> Added:</strong><br>
                                {{ get_app_state().current_repo.added_at[:19] }}
                            </div>
                            <div>
                                <strong><i class="fas fa-tasks"></i> Status:</strong><br>
                                <span id="analysis-status" class="status-indicator status-{{ get_app_state().analysis_status }}">
                                    {{ get_app_state().analysis_status.title() }}
                                </span>
                            </div>
                            <div id="commit-status-container">
                                <strong><i class="fas fa-code-branch"></i> Commits:</strong><br>
                                <span id="commit-status" class="status-indicator status-idle">
                                    Checking...
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Commit Status Alert -->
                    <div id="commit-alert" class="hidden"></div>
                {% endif %}

                <!-- Add Repository Form -->
                <div class="repo-form">
                    <div class="form-group">
                        <label for="repo-url">
                            <i class="fas fa-link"></i> Repository URL or owner/name
                        </label>
                        <input type="text" id="repo-url" class="form-control" 
                               placeholder="https://github.com/owner/repo or owner/repo">
                    </div>
                    
                    <!-- Analysis Options -->
                    {% if get_app_state().current_repo %}
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="skipGitHubArtifacts"> 
                            <i class="fas fa-rocket"></i> Skip GitHub artifacts (faster analysis, no commits/issues/PRs)
                        </label>
                    </div>
                    {% endif %}
                    
                    <div class="actions">
                        <button onclick="addRepository()" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Repository
                        </button>
                        {% if get_app_state().current_repo %}
                            <button onclick="analyzeRepository()" class="btn btn-success">
                                <i class="fas fa-search"></i> Analyze Repository
                            </button>
                            <button onclick="checkStatus()" class="btn btn-secondary">
                                <i class="fas fa-chart-line"></i> Check Status
                            </button>
                        {% endif %}
                    </div>
                    
                    <!-- Real-time Progress Simulation -->
                    <div id="progress-simulation" class="progress-simulation" style="display: none;">
                        <h3><i class="fas fa-tasks"></i> Analysis Progress</h3>
                        <div class="progress-step" id="step-1">
                            <div class="progress-icon pending" id="icon-1">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="progress-text">
                                <div class="progress-title">Repository Added</div>
                                <div class="progress-description">Repository URL validated and added to queue</div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-2">
                            <div class="progress-icon pending" id="icon-2">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="progress-text">
                                <div class="progress-title">Repository Cloned</div>
                                <div class="progress-description">Downloading source code and metadata from GitHub</div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-3">
                            <div class="progress-icon pending" id="icon-3">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="progress-text">
                                <div class="progress-title">Entity Extraction</div>
                                <div class="progress-description">Parsing code and extracting classes, functions, and relationships</div>
                                <div class="knowledge-preview" id="entities-preview">
                                    <div class="knowledge-stats" id="entity-stats">
                                        <div class="knowledge-stat">Classes: <span id="classes-count">0</span></div>
                                        <div class="knowledge-stat">Functions: <span id="functions-count">0</span></div>
                                        <div class="knowledge-stat">Tests: <span id="tests-count">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-4">
                            <div class="progress-icon pending" id="icon-4">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="progress-text">
                                <div class="progress-title">Knowledge Graph Building</div>
                                <div class="progress-description">Constructing relationships and building graph structure</div>
                                <div class="knowledge-preview" id="graph-preview">
                                    <div class="knowledge-stats" id="graph-stats">
                                        <div class="knowledge-stat">Nodes: <span id="nodes-count">0</span></div>
                                        <div class="knowledge-stat">Relationships: <span id="relationships-count">0</span></div>
                                    </div>
                                    <div class="mini-graph" id="mini-graph-viz"></div>
                                </div>
                            </div>
                        </div>
                        <div class="progress-step" id="step-5">
                            <div class="progress-icon pending" id="icon-5">
                                <i class="fas fa-database"></i>
                            </div>
                            <div class="progress-text">
                                <div class="progress-title">Kuzu Database Storage</div>
                                <div class="progress-description">Persisting knowledge graph to embedded database</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status and Updates -->
            <div id="status-section" class="card hidden slide-up">
                <h2>
                    <i class="fas fa-chart-bar"></i>
                    Repository Status
                </h2>
                <div id="status-content"></div>
            </div>

            <!-- Knowledge Graph Stats -->
            <div id="stats-section" class="card hidden slide-up">
                <h2>
                    <i class="fas fa-brain"></i>
                    Knowledge Graph Statistics
                </h2>
                <div id="stats-content">
                    <button onclick="loadStats()" class="btn btn-secondary">
                        <i class="fas fa-chart-pie"></i> Load Statistics
                    </button>
                </div>
            </div>

            <!-- Knowledge Graph Visualization -->
            <div id="kg-visualization-section" class="card hidden slide-up">
                <h2>
                    <i class="fas fa-project-diagram"></i>
                    Knowledge Graph Visualization
                </h2>
                
                <div class="actions" style="margin-bottom: 20px;">
                    <button onclick="loadKnowledgeGraph()" class="btn btn-primary">
                        <i class="fas fa-eye"></i> Load Graph
                    </button>
                    <button onclick="resetGraphView()" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reset View
                    </button>
                    <button onclick="toggleGraphLegend()" class="btn btn-secondary">
                        <i class="fas fa-info-circle"></i> Toggle Legend
                    </button>
                    <button onclick="exportGraphData()" class="btn btn-accent">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>
                
                <!-- Graph Controls -->
                <div class="graph-controls" style="margin-bottom: 20px; padding: 15px; background: rgba(220, 215, 201, 0.3); border-radius: 8px;">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div>
                            <label for="node-filter">Filter Nodes:</label>
                            <select id="node-filter" onchange="filterNodes()">
                                <option value="all">All Types</option>
                                <option value="class">Classes</option>
                                <option value="function">Functions</option>
                                <option value="method">Methods</option>
                                <option value="test">Tests</option>
                                <option value="file">Files</option>
                            </select>
                        </div>
                        <div>
                            <label for="relationship-filter">Filter Relationships:</label>
                            <select id="relationship-filter" onchange="filterRelationships()">
                                <option value="all">All Types</option>
                                <option value="CALLS">Calls</option>
                                <option value="IMPORTS">Imports</option>
                                <option value="TESTS">Tests</option>
                                <option value="BELONGS_TO">Belongs To</option>
                            </select>
                        </div>
                        <div>
                            <label for="graph-layout">Layout:</label>
                            <select id="graph-layout" onchange="changeGraphLayout()">
                                <option value="force">Force-Directed</option>
                                <option value="hierarchical">Hierarchical</option>
                                <option value="circular">Circular</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Graph Statistics -->
                <div id="graph-stats" class="stats-grid" style="margin-bottom: 20px; display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="total-nodes-stat">0</div>
                        <div class="stat-label">Total Nodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-edges-stat">0</div>
                        <div class="stat-label">Total Edges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="node-types-stat">0</div>
                        <div class="stat-label">Node Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="edge-types-stat">0</div>
                        <div class="stat-label">Edge Types</div>
                    </div>
                </div>
                
                <!-- Graph Legend -->
                <div id="graph-legend" class="graph-legend" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(255, 255, 255, 0.9); border-radius: 8px; border: 1px solid var(--color-light);">
                    <h4><i class="fas fa-palette"></i> Legend</h4>
                    <div class="legend-content">
                        <div class="legend-section">
                            <h5>Node Types:</h5>
                            <div class="legend-items" id="node-legend"></div>
                        </div>
                        <div class="legend-section">
                            <h5>Relationship Types:</h5>
                            <div class="legend-items" id="relationship-legend"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Graph Container -->
                <div id="kg-graph-container" style="width: 100%; height: 600px; border: 2px solid var(--color-light); border-radius: 12px; background: #ffffff; position: relative; overflow: hidden;">
                    <div id="kg-graph-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-muted);">
                        <i class="fas fa-project-diagram" style="font-size: 4rem; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p style="font-size: 1.2rem; font-weight: 600;">Click "Load Graph" to visualize the knowledge graph</p>
                    </div>
                    <svg id="kg-graph-svg" width="100%" height="100%" style="display: none;"></svg>
                </div>
                
                <!-- Node Details Panel -->
                <div id="node-details" class="node-details" style="display: none; margin-top: 20px; padding: 20px; background: rgba(162, 123, 92, 0.1); border-radius: 12px; border-left: 4px solid var(--color-accent);">
                    <h4><i class="fas fa-info-circle"></i> Node Details</h4>
                    <div id="node-details-content"></div>
                </div>
            </div>

            <!-- Kuzu Database -->
            <div id="kuzu-section" class="card hidden slide-up">
                <h2>
                    <i class="fas fa-database"></i>
                    Kuzu Database
                </h2>
                <div class="actions">
                    <button onclick="loadKuzuStats()" class="btn btn-secondary">
                        <i class="fas fa-chart-line"></i> Database Stats
                    </button>
                    <button onclick="loadKuzuNodes()" class="btn btn-secondary">
                        <i class="fas fa-circle-nodes"></i> Show All Nodes
                    </button>
                    <button onclick="loadKuzuRelationships()" class="btn btn-secondary">
                        <i class="fas fa-share-alt"></i> Show All Relationships
                    </button>
                    <button onclick="clearKuzuDatabase()" class="btn btn-danger" style="margin-left: 20px;">
                        <i class="fas fa-trash"></i> Clear Database
                    </button>
                </div>
                <div id="kuzu-content" style="margin-top: 20px;"></div>
            </div>

            <!-- Export Data -->
            <div class="card slide-up">
                <h2>
                    <i class="fas fa-download"></i>
                    Export Data
                </h2>
                <div class="actions">
                    <button onclick="exportData('jsonl')" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> Export as JSONL
                    </button>
                </div>
            </div>

        {% else %}
            <!-- Not Authenticated -->
            <div class="auth-login-card slide-up">
                <div class="auth-icon">
                    <i class="fab fa-github"></i>
                </div>
                <h2>Welcome to GATeR</h2>
                <p>
                    Connect your GitHub account to unlock powerful repository analysis and knowledge graph construction capabilities.
                    <br><br>
                    <strong>Features:</strong><br>
                    • Code entity extraction & relationship mapping<br>
                    • GitHub issues & PR integration<br>
                    • Interactive knowledge graphs<br>
                    • Real-time analysis progress tracking
                </p>
                <a href="/auth/login" class="btn btn-primary" style="font-size: 1.1rem; padding: 15px 30px;">
                    <i class="fab fa-github"></i> Connect GitHub Account
                </a>
            </div>
        {% endif %}

        <!-- Alerts -->
        <div id="alerts"></div>
        
        <!-- Global data -->
        <script type="application/json" id="app-data">{{ current_repo_json | safe }}</script>
        <script type="application/json" id="analysis-status-data">"{{ get_app_state().analysis_status }}"</script>
        <script type="application/json" id="repo-status">{{ repo_status_json | safe }}</script>
    </div>

    <script>
        // Global state - Initialize with safe defaults
        let currentRepo = null;
        let currentAnalysisStatus = 'idle';
        let repoStatus = {};
        let autoRefreshInterval;

        // Initialize data safely
        try {
            currentRepo = JSON.parse(document.getElementById('app-data').textContent);
        } catch (e) {
            console.warn('Failed to parse app data:', e);
            currentRepo = null;
        }

        try {
            const statusElement = document.getElementById('analysis-status-data');
            if (statusElement) {
                console.log('Status element content:', statusElement.textContent);
                currentAnalysisStatus = JSON.parse(statusElement.textContent);
                console.log('Parsed analysis status:', currentAnalysisStatus);
            } else {
                console.warn('Analysis status data element not found');
                currentAnalysisStatus = 'idle';
            }
        } catch (e) {
            console.warn('Failed to parse analysis status:', e);
            currentAnalysisStatus = 'idle';
        }

        try {
            repoStatus = JSON.parse(document.getElementById('repo-status').textContent);
        } catch (e) {
            console.warn('Failed to parse repo status:', e);
            repoStatus = {};
        }

        // Auto-refresh indicator
        function showAutoRefresh() {
            const indicator = document.getElementById('auto-refresh-indicator');
            indicator.classList.remove('hidden');
            indicator.classList.add('updating');
        }

        function hideAutoRefresh() {
            const indicator = document.getElementById('auto-refresh-indicator');
            indicator.classList.add('hidden');
            indicator.classList.remove('updating');
        }

        // Enhanced status update function
        function updateAnalysisStatus(newStatus) {
            // Ensure currentAnalysisStatus is defined
            if (typeof currentAnalysisStatus === 'undefined') {
                window.currentAnalysisStatus = 'idle';
            }
            
            currentAnalysisStatus = newStatus;
            const statusElement = document.getElementById('analysis-status');
            if (statusElement) {
                statusElement.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                statusElement.className = `status-indicator status-${newStatus}`;
                
                // Add animation for status changes
                statusElement.classList.add('slide-up');
                setTimeout(() => statusElement.classList.remove('slide-up'), 300);
            }
        }

        // Utility functions
        function showAlert(message, type = 'info') {
            const alertsContainer = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} fade-in`;
            
            const icon = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';
            
            alert.innerHTML = `<i class="${icon}"></i>${message}`;
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showLoading(button) {
            button.disabled = true;
            const originalText = button.innerHTML;
            button.setAttribute('data-original-text', originalText);
            button.innerHTML = '<span class="loading"></span> ' + button.innerHTML.replace(/<span class="loading"><\/span>\s*/, '');
        }

        function hideLoading(button) {
            button.disabled = false;
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
            button.innerHTML = originalText;
            }
        }

        // Progress simulation functions
        function showProgressSimulation() {
            const progressDiv = document.getElementById('progress-simulation');
            if (progressDiv) {
                progressDiv.style.display = 'block';
                resetProgressSteps();
            }
        }
        
        function hideProgressSimulation() {
            const progressDiv = document.getElementById('progress-simulation');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }
        
        function resetProgressSteps() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step-${i}`);
                const icon = document.getElementById(`icon-${i}`);
                if (step && icon) {
                    step.className = 'progress-step';
                    icon.className = 'progress-icon pending';
                }
            }
        }
        
        function showProgressStep(stepNumber) {
            const step = document.getElementById(`step-${stepNumber}`);
            if (step) {
                step.classList.add('visible');
                // Small delay for smooth animation
                setTimeout(() => {
                    step.style.transform = 'translateX(0)';
                    step.style.opacity = '1';
                }, 100);
            }
        }
        
        function updateProgressStep(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            const icon = document.getElementById(`icon-${stepNumber}`);
            
            if (step && icon) {
                // Ensure step is visible first
                if (!step.classList.contains('visible')) {
                    showProgressStep(stepNumber);
                }
                
                // Reset classes
                step.className = 'progress-step visible';
                icon.className = 'progress-icon';
                
                // Add new status
                if (status === 'active') {
                    step.classList.add('active');
                    icon.classList.add('active');
                } else if (status === 'completed') {
                    step.classList.add('completed');
                    icon.classList.add('completed');
                } else {
                    icon.classList.add('pending');
                }
            }
        }
        
        function showKnowledgePreview(stepNumber, data) {
            const previewId = stepNumber === 3 ? 'entities-preview' : 'graph-preview';
            const preview = document.getElementById(previewId);
            
            if (preview && data) {
                if (stepNumber === 3) {
                    // Entity extraction preview
                    document.getElementById('classes-count').textContent = data.classes || 0;
                    document.getElementById('functions-count').textContent = data.functions || 0;
                    document.getElementById('tests-count').textContent = data.tests || 0;
                } else if (stepNumber === 4) {
                    // Knowledge graph preview
                    document.getElementById('nodes-count').textContent = data.nodes || 0;
                    document.getElementById('relationships-count').textContent = data.relationships || 0;
                    generateMiniGraph(data.nodes || 0, data.relationships || 0);
                }
                
                preview.classList.add('show');
            }
        }
        
        function generateMiniGraph(nodeCount, relCount) {
            const container = document.getElementById('mini-graph-viz');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Generate random nodes
            const nodes = Math.min(nodeCount, 8); // Limit for visual clarity
            for (let i = 0; i < nodes; i++) {
                const node = document.createElement('div');
                node.className = 'graph-node';
                node.style.left = Math.random() * 85 + '%';
                node.style.top = Math.random() * 85 + '%';
                node.style.animationDelay = (i * 0.2) + 's';
                container.appendChild(node);
            }
            
            // Generate random edges
            const edges = Math.min(relCount, 6);
            for (let i = 0; i < edges; i++) {
                const edge = document.createElement('div');
                edge.className = 'graph-edge';
                edge.style.left = Math.random() * 70 + '%';
                edge.style.top = Math.random() * 90 + '%';
                edge.style.width = Math.random() * 30 + 20 + 'px';
                edge.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(edge);
            }
        }
        
        let progressPollingInterval = null;
        
        function startRealTimeProgressTracking() {
            showProgressSimulation();
            
            // Poll for progress updates every 500ms
            progressPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch('/repo/progress');
                    const data = await response.json();
                    
                    if (data.progress && data.progress.step > 0) {
                        updateRealProgress(data.progress);
                    }
                    
                    // Stop polling when analysis is complete or failed
                    if (data.status === 'completed' || data.status === 'error') {
                        clearInterval(progressPollingInterval);
                        progressPollingInterval = null;
                        
                        if (data.status === 'completed') {
                            // Keep visible for a moment then refresh
                            setTimeout(() => {
                                hideProgressSimulation();
                                checkStatus();
                            }, 2000);
                        } else {
                            hideProgressSimulation();
                        }
                    }
                } catch (error) {
                    console.error('Error polling progress:', error);
                }
            }, 500);
        }
        
        function updateRealProgress(progress) {
            const { step, step_name, step_description, details } = progress;
            
            // Show all steps up to current step
            for (let i = 1; i <= step; i++) {
                if (i < step) {
                    updateProgressStep(i, 'completed');
                } else {
                    updateProgressStep(i, 'active');
                }
            }
            
            // Show knowledge previews with real data
            if (step === 3 && details && (details.classes || details.functions || details.tests)) {
                showKnowledgePreview(3, details);
            } else if (step === 4 && details && (details.nodes || details.relationships)) {
                showKnowledgePreview(4, details);
            }
        }
        
        function stopProgressTracking() {
            if (progressPollingInterval) {
                clearInterval(progressPollingInterval);
                progressPollingInterval = null;
            }
        }

        // Repository management
        async function addRepository() {
            const repoUrl = document.getElementById('repo-url').value.trim();
            if (!repoUrl) {
                showAlert('Please enter a repository URL', 'error');
                return;
            }

            const button = event.target;
            showLoading(button);

            try {
                const response = await fetch('/repo/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ repo_url: repoUrl })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    currentRepo = data.repo_info;
                    
                    // Update status immediately without page reload
                    updateAnalysisStatus('idle');
                    
                    // Reload page to show the new repository UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Error adding repository: ' + error.message, 'error');
            } finally {
                hideLoading(button);
            }
        }

        async function analyzeRepository() {
            console.log('Analyze button clicked', currentRepo);
            
            if (!currentRepo) {
                showAlert('No repository selected. Please add a repository first.', 'error');
                return;
            }
            
            if (!currentRepo.owner || !currentRepo.name) {
                showAlert('Invalid repository data. Please refresh the page and try again.', 'error');
                return;
            }

            const button = event.target;
            showLoading(button);

            try {
                // Update status immediately
                updateAnalysisStatus('analyzing');
                console.log('Starting analysis request...');
                
                // Start real-time progress tracking
                startRealTimeProgressTracking();
                
                const response = await fetch('/repo/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        skip_github_artifacts: document.getElementById('skipGitHubArtifacts') ? document.getElementById('skipGitHubArtifacts').checked : false
                    })
                });

                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    updateAnalysisStatus('completed');
                    
                    // Auto-load stats after analysis
                    setTimeout(() => {
                        loadStats();
                        checkStatus();
                    }, 1000);
                } else {
                    showAlert(data.error, 'error');
                    updateAnalysisStatus('error');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showAlert('Error analyzing repository: ' + error.message, 'error');
                updateAnalysisStatus('error');
                stopProgressTracking();
                hideProgressSimulation();
            } finally {
                hideLoading(button);
            }
        }

        async function checkStatus() {
            if (!currentRepo) {
                showAlert('No repository selected', 'error');
                return;
            }

            showAutoRefresh();

            try {
                const response = await fetch('/repo/status');
                const data = await response.json();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }

                displayStatus(data);
            } catch (error) {
                showAlert('Error checking status: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        function displayStatus(data) {
            const statusSection = document.getElementById('status-section');
            const statusContent = document.getElementById('status-content');
            
            // Check if elements exist
            if (!statusSection || !statusContent) {
                console.warn('Status elements not found in DOM');
                return;
            }
            
            let html = '';
            
            // Local status
            if (data.local_status && data.local_status.exists) {
                const commit = data.local_status.current_commit;
                html += `
                    <div class="repo-info">
                        <h3><i class="fas fa-folder"></i> Local Repository</h3>
                        <div class="repo-meta">
                            <div><strong><i class="fas fa-code-branch"></i> Branch:</strong><br>${data.local_status.current_branch}</div>
                            <div><strong><i class="fas fa-code-commit"></i> Commit:</strong><br>${commit.sha.substring(0, 8)}</div>
                            <div><strong><i class="fas fa-user"></i> Author:</strong><br>${commit.author}</div>
                            <div><strong><i class="fas fa-clock"></i> Date:</strong><br>${new Date(commit.date).toLocaleString()}</div>
                        </div>
                        <p style="margin-top: 15px; font-style: italic; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <i class="fas fa-comment"></i> ${commit.message}
                        </p>
                    </div>
                `;
            }

            // Remote status
            if (data.remote_status) {
                if (data.remote_status.up_to_date === false) {
                    html += `
                        <div class="alert alert-info">
                            <i class="fas fa-sync-alt"></i>
                            <div>
                                <strong>Updates Available</strong><br>
                            Your repository is ${data.remote_status.commits_behind} commit(s) behind the remote.
                            <div class="actions" style="margin-top: 15px;">
                                <button onclick="pullChanges()" class="btn btn-primary">
                                        <i class="fas fa-download"></i> Pull Changes
                                </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Show new commits
                    if (data.remote_status.new_commits && data.remote_status.new_commits.length > 0) {
                        html += '<h4><i class="fas fa-history"></i> New Commits:</h4>';
                        data.remote_status.new_commits.forEach(commit => {
                            html += `
                                <div style="margin: 15px 0; padding: 20px; background: #f8f9fa; border-radius: 12px; border-left: 4px solid var(--color-accent);">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <i class="fas fa-code-commit" style="color: var(--color-accent);"></i>
                                        <strong>${commit.sha.substring(0, 8)}</strong> 
                                        <span>by ${commit.author}</span>
                                    </div>
                                    <div style="margin: 8px 0; padding-left: 24px;">${commit.message}</div>
                                    <div style="font-size: 0.9rem; color: #666; padding-left: 24px;">
                                        <i class="fas fa-clock"></i> ${new Date(commit.date).toLocaleString()}
                                    </div>
                                </div>
                            `;
                        });
                    }
                } else if (data.remote_status.up_to_date === true) {
                    html += `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Up to Date</strong><br>
                            Your repository is up to date with the remote.
                            </div>
                        </div>
                    `;
                }
            }

            // Analysis status
            if (data.last_analysis) {
                html += `
                    <div class="card" style="margin-top: 20px; background-color: #f8f9fa;">
                        <h4><i class="fas fa-analytics"></i> Last Analysis</h4>
                        <p><strong><i class="fas fa-clock"></i> Time:</strong> ${new Date(data.last_analysis.timestamp).toLocaleString()}</p>
                        <p><strong><i class="fas fa-cog"></i> Type:</strong> ${data.last_analysis.type || 'full'}</p>
                    </div>
                `;
            }

            statusContent.innerHTML = html;
            statusSection.classList.remove('hidden');
            statusSection.classList.add('fade-in');
            
            // Also show Kuzu section when repo is loaded
            const kuzuSection = document.getElementById('kuzu-section');
            kuzuSection.classList.remove('hidden');
            kuzuSection.classList.add('fade-in');
            
            // Show knowledge graph visualization section
            showKnowledgeGraphSection();
        }

        async function loadStats() {
            showAutoRefresh();
            
            try {
                const response = await fetch('/knowledge-graph/stats');
                const data = await response.json();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }

                displayStats(data);
            } catch (error) {
                showAlert('Error loading stats: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        function displayStats(stats) {
            const statsSection = document.getElementById('stats-section');
            const statsContent = document.getElementById('stats-content');
            
            // Check if elements exist
            if (!statsSection || !statsContent) {
                console.warn('Stats elements not found in DOM');
                return;
            }
            
            const html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_nodes || 0}</div>
                        <div class="stat-label"><i class="fas fa-circle"></i> Total Nodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_edges || 0}</div>
                        <div class="stat-label"><i class="fas fa-share-alt"></i> Total Edges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.node_types ? Object.keys(stats.node_types).length : 0}</div>
                        <div class="stat-label"><i class="fas fa-tags"></i> Entity Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.relationship_types ? Object.keys(stats.relationship_types).length : 0}</div>
                        <div class="stat-label"><i class="fas fa-project-diagram"></i> Relationship Types</div>
                    </div>
                </div>
                
                ${stats.node_types ? `
                    <div style="margin-top: 40px;">
                        <h4><i class="fas fa-shapes"></i> Entity Types</h4>
                        <div class="stats-grid">
                            ${Object.entries(stats.node_types).map(([type, count]) => `
                                <div class="stat-card">
                                    <div class="stat-value">${count}</div>
                                    <div class="stat-label">${type}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${stats.relationship_types ? `
                    <div style="margin-top: 40px;">
                        <h4><i class="fas fa-sitemap"></i> Relationship Types</h4>
                        <div class="stats-grid">
                            ${Object.entries(stats.relationship_types).map(([type, count]) => `
                                <div class="stat-card">
                                    <div class="stat-value">${count}</div>
                                    <div class="stat-label">${type}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            statsContent.innerHTML = html;
            statsSection.classList.remove('hidden');
            statsSection.classList.add('fade-in');
        }

        async function exportData(format) {
            try {
                const response = await fetch(`/export/${format}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        // Commit status checking functions
        async function checkCommitStatus() {
            if (!currentRepo) return;

            try {
                const response = await fetch('/repo/check-updates');
                const data = await response.json();
                
                if (data.error) {
                    updateCommitStatus('Error', 'error');
                    return;
                }

                if (!data.repo_exists) {
                    updateCommitStatus('Not cloned', 'idle');
                    return;
                }

                // Update global repo status
                repoStatus = {
                    commits_behind: data.commits_behind,
                    up_to_date: data.up_to_date,
                    last_check: data.last_check,
                    new_commits: data.new_commits || []
                };

                if (data.up_to_date) {
                    updateCommitStatus('Up to date', 'completed');
                    hideCommitAlert();
                } else {
                    const commitsText = data.commits_behind === 1 ? '1 commit behind' : `${data.commits_behind} commits behind`;
                    updateCommitStatus(commitsText, 'behind');
                    showCommitAlert(data.commits_behind, data.new_commits);
                }

            } catch (error) {
                console.error('Error checking commit status:', error);
                updateCommitStatus('Check failed', 'error');
            }
        }

        function updateCommitStatus(text, statusClass) {
            const statusElement = document.getElementById('commit-status');
            if (statusElement) {
                statusElement.textContent = text;
                statusElement.className = `status-indicator status-${statusClass}`;
            }
        }

        function showCommitAlert(commitsBehind, newCommits) {
            const alertContainer = document.getElementById('commit-alert');
            if (!alertContainer) return;

            const commitsText = commitsBehind === 1 ? '1 commit' : `${commitsBehind} commits`;
            let html = `
                <div class="alert alert-info">
                    <i class="fas fa-sync-alt"></i>
                    <div>
                        <strong>Updates Available</strong><br>
                    Your repository is ${commitsText} behind the remote.
                    <div class="actions" style="margin-top: 15px;">
                        <button onclick="pullChanges()" class="btn btn-primary">
                                <i class="fas fa-download"></i> Pull Changes
                        </button>
                        <button onclick="hideCommitAlert()" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Dismiss
                        </button>
                        </div>
                    </div>
                </div>
            `;

            // Show new commits if available
            if (newCommits && newCommits.length > 0) {
                html += '<div style="margin-top: 20px;"><h4><i class="fas fa-history"></i> New Commits:</h4>';
                newCommits.slice(0, 3).forEach(commit => {
                    html += `
                        <div style="margin: 15px 0; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                            <div style="font-weight: bold; margin-bottom: 8px;">
                                <i class="fas fa-code-commit"></i> ${commit.sha.substring(0, 8)} by ${commit.author}
                            </div>
                            <div style="margin: 8px 0;">${commit.message}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">
                                <i class="fas fa-clock"></i> ${new Date(commit.date).toLocaleDateString()}
                            </div>
                        </div>
                    `;
                });
                if (newCommits.length > 3) {
                    html += `<div style="font-style: italic; opacity: 0.8; text-align: center; margin-top: 10px;">
                        <i class="fas fa-ellipsis-h"></i> and ${newCommits.length - 3} more commits
                    </div>`;
                }
                html += '</div>';
            }

            alertContainer.innerHTML = html;
            alertContainer.classList.remove('hidden');
            alertContainer.classList.add('fade-in');
        }

        function hideCommitAlert() {
            const alertContainer = document.getElementById('commit-alert');
            if (alertContainer) {
                alertContainer.classList.add('hidden');
            }
        }

        async function pullChanges() {
            const button = event.target;
            showLoading(button);

            try {
                const response = await fetch('/repo/pull', {
                    method: 'POST'
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Changes pulled and analyzed successfully! 🎉', 'success');
                    hideCommitAlert();
                    
                    // Refresh status and stats after pull
                    setTimeout(() => {
                        checkCommitStatus();
                        checkStatus();
                        loadStats();
                    }, 1000);
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Error pulling changes: ' + error.message, 'error');
            } finally {
                hideLoading(button);
            }
        }

        // Enhanced Kuzu Database Functions with new styling
        async function loadKuzuStats() {
            showAutoRefresh();
            
            try {
                const response = await fetch('/kuzu/stats');
                const data = await response.json();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }

                const kuzuContent = document.getElementById('kuzu-content');
                
                // Check if element exists
                if (!kuzuContent) {
                    console.warn('Kuzu content element not found');
                    return;
                }
                
                // Check if Kuzu is available
                if (data.kuzu_available === false) {
                    kuzuContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <h3 style="margin-bottom: 10px;">Kuzu Database Not Available</h3>
                                <p>The Kuzu database library is not installed. The system is running with in-memory storage only.</p>
                                <p style="margin-top: 10px; font-size: 14px;">
                                    To enable Kuzu database features, install with: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">pip install kuzu==0.5.0</code>
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = '<h3><i class="fas fa-chart-bar"></i> Database Statistics</h3><div class="stats-grid" style="margin-top: 20px;">';

                // Node counts
                const nodeTypes = ['codeentity', 'commit', 'issue', 'pullrequest', 'repository'];
                nodeTypes.forEach(type => {
                    const count = data[`${type}_count`] || 0;
                    html += `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        </div>
                    `;
                });

                html += '</div><h4 style="margin-top: 30px;"><i class="fas fa-share-alt"></i> Relationships</h4><div class="stats-grid" style="margin-top: 15px;">';

                // Relationship counts
                const relTypes = ['belongs_to', 'calls', 'imports', 'modifies', 'tests', 'mentions_issue', 'mentions_pr'];
                relTypes.forEach(type => {
                    const count = data[`${type}_count`] || 0;
                    html += `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${type.replace('_', ' ').toUpperCase()}</div>
                        </div>
                    `;
                });

                html += '</div>';
                
                // Total summary
                html += `
                    <div style="margin-top: 30px; padding: 25px; background: var(--color-light); border-radius: 16px; text-align: center; border: 2px solid var(--color-accent);">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;"><i class="fas fa-chart-pie"></i> Total Summary</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p style="font-size: 24px; font-weight: bold; color: var(--color-accent); margin: 0;"><i class="fas fa-circle"></i> ${data.total_nodes || 0}</p>
                                <p style="margin: 5px 0; font-weight: 600;">Nodes</p>
                            </div>
                            <div>
                                <p style="font-size: 24px; font-weight: bold; color: var(--color-accent); margin: 0;"><i class="fas fa-share-alt"></i> ${data.total_relationships || 0}</p>
                                <p style="margin: 5px 0; font-weight: 600;">Relationships</p>
                            </div>
                        </div>
                    </div>
                `;

                kuzuContent.innerHTML = html;
                
            } catch (error) {
                showAlert('Failed to load Kuzu stats: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        async function loadKuzuNodes() {
            try {
                const limit = prompt('Enter limit for nodes (default: 100):', '100');
                if (!limit) return;
                
                showAutoRefresh();
                
                const response = await fetch(`/kuzu/nodes?limit=${limit}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }

                const kuzuContent = document.getElementById('kuzu-content');
                
                // Check if element exists
                if (!kuzuContent) {
                    console.warn('Kuzu content element not found');
                    return;
                }
                
                // Check if no nodes available (Kuzu not available)
                if (!data.nodes || data.nodes.length === 0) {
                    kuzuContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <h3 style="margin-bottom: 10px;">No Kuzu Database Nodes</h3>
                                <p>The Kuzu database is not available or contains no data.</p>
                                <p style="margin-top: 10px; font-size: 14px;">
                                    Install Kuzu with: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">pip install kuzu==0.5.0</code>
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = `<h3><i class="fas fa-circle-nodes"></i> Database Nodes (${data.count})</h3>`;
                
                html += '<div class="scrollable-table">';
                html += '<table class="data-table">';
                html += '<thead><tr><th><i class="fas fa-table"></i> Table</th><th><i class="fas fa-fingerprint"></i> ID</th><th><i class="fas fa-tag"></i> Name</th><th><i class="fas fa-shapes"></i> Type</th></tr></thead><tbody>';
                
                data.nodes.forEach(node => {
                    const nodeData = node.data || {};
                    html += `
                        <tr>
                            <td>${node.table}</td>
                            <td style="font-family: 'Courier New', monospace; font-size: 12px;">${nodeData.id || 'N/A'}</td>
                            <td>${nodeData.name || 'N/A'}</td>
                            <td><span style="background: var(--color-light); padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${nodeData.type || 'N/A'}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';

                kuzuContent.innerHTML = html;
                
            } catch (error) {
                showAlert('Failed to load Kuzu nodes: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        async function loadKuzuRelationships() {
            try {
                const limit = prompt('Enter limit for relationships (default: 100):', '100');
                if (!limit) return;
                
                showAutoRefresh();
                
                const response = await fetch(`/kuzu/relationships?limit=${limit}`);
                const data = await response.json();
                
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }

                const kuzuContent = document.getElementById('kuzu-content');
                
                // Check if element exists
                if (!kuzuContent) {
                    console.warn('Kuzu content element not found');
                    return;
                }
                
                // Check if no relationships available (Kuzu not available)
                if (!data.relationships || data.relationships.length === 0) {
                    kuzuContent.innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <h3 style="margin-bottom: 10px;">No Kuzu Database Relationships</h3>
                                <p>The Kuzu database is not available or contains no relationships.</p>
                                <p style="margin-top: 10px; font-size: 14px;">
                                    Install Kuzu with: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">pip install kuzu==0.5.0</code>
                                </p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                let html = `<h3><i class="fas fa-share-alt"></i> Database Relationships (${data.count})</h3>`;
                
                html += '<div class="scrollable-table">';
                html += '<table class="data-table">';
                html += '<thead><tr><th><i class="fas fa-tag"></i> Type</th><th><i class="fas fa-arrow-right"></i> Source</th><th><i class="fas fa-bullseye"></i> Target</th></tr></thead><tbody>';
                
                data.relationships.forEach(rel => {
                    html += `
                        <tr>
                            <td><span style="background: var(--color-accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">${rel.type}</span></td>
                            <td style="font-family: 'Courier New', monospace; font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${rel.source}</td>
                            <td style="font-family: 'Courier New', monospace; font-size: 11px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${rel.target}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';

                kuzuContent.innerHTML = html;
                
            } catch (error) {
                showAlert('Failed to load Kuzu relationships: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        async function clearKuzuDatabase() {
            if (!confirm('⚠️ WARNING: Are you sure you want to clear the entire Kuzu database? This action cannot be undone!')) {
                return;
            }

            showAutoRefresh();

            try {
                const response = await fetch('/kuzu/clear', { method: 'POST' });
                const data = await response.json();
                
                const kuzuContent = document.getElementById('kuzu-content');
                if (!kuzuContent) {
                    console.warn('Kuzu content element not found');
                    return;
                }
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    kuzuContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--color-success);"></i>
                            <p style="font-size: 1.2rem; font-weight: 600;">Database cleared successfully</p>
                        </div>
                    `;
                } else {
                    // Show appropriate message for when Kuzu is not available
                    const errorMsg = data.message || 'Kuzu database is not available';
                    kuzuContent.innerHTML = `
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-circle"></i>
                            <div>
                                <h3 style="margin-bottom: 10px;">Cannot Clear Database</h3>
                                <p>${errorMsg}</p>
                                <p style="margin-top: 10px; font-size: 14px;">
                                    Install Kuzu with: <code style="background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px;">pip install kuzu==0.5.0</code>
                                </p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                showAlert('Failed to clear Kuzu database: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        // Enhanced auto-refresh with status polling
        if (currentRepo) {
            // Check commit status immediately
            checkCommitStatus();
            
            // Set up auto-refresh with enhanced status checking
            autoRefreshInterval = setInterval(async () => {
                if (currentAnalysisStatus !== 'analyzing') {
                    // Check for status updates from server
                    try {
                        const response = await fetch('/repo/analysis-status');
                        const data = await response.json();
                        
                        if (data.status && data.status !== currentAnalysisStatus) {
                            updateAnalysisStatus(data.status);
                            
                            // If analysis completed, auto-load stats
                            if (data.status === 'completed') {
                                setTimeout(() => {
                                    loadStats();
                                    checkStatus();
                                }, 1000);
                            }
                        }
                    } catch (error) {
                        // Silently handle status check errors
                        console.log('Status check failed:', error);
                    }
                    
                    checkCommitStatus(); // Check commits every 30 seconds
                    
                    // Only check full status every 2 minutes to avoid overloading
                    const now = new Date();
                    if (now.getMinutes() % 2 === 0 && now.getSeconds() < 30) {
                        checkStatus();
                    }
                }
            }, 30000);
        }

        // Load initial data if repository exists
        document.addEventListener('DOMContentLoaded', function() {
            // Add fade-in animation to all cards
            document.querySelectorAll('.card').forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
            
            if (currentRepo) {
                // Always check commit status when page loads
                setTimeout(() => {
                    checkCommitStatus();
                }, 1000);
                
                // Load stats and status if analysis is completed
                if ('{{ get_app_state().analysis_status }}' === 'completed') {
                    setTimeout(() => {
                        loadStats();
                        checkStatus();
                    }, 1500);
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });

        // Knowledge Graph Visualization Functions
        let graphData = null;
        let simulation = null;
        let svg = null;
        let g = null;
        let nodeColorScale = null;
        let linkColorScale = null;
        let selectedNode = null;

        // Color schemes for different node and edge types
        const nodeColors = {
            'class': '#e74c3c',
            'function': '#3498db', 
            'method': '#2980b9',
            'test': '#27ae60',
            'file': '#f39c12',
            'repository': '#9b59b6',
            'issue': '#e67e22',
            'pull_request': '#1abc9c',
            'commit': '#34495e',
            'unknown': '#95a5a6'
        };

        const linkColors = {
            'CALLS': '#3498db',
            'IMPORTS': '#e74c3c', 
            'TESTS': '#27ae60',
            'BELONGS_TO': '#f39c12',
            'MODIFIES': '#9b59b6',
            'MENTIONS_ISSUE': '#e67e22',
            'MENTIONS_PR': '#1abc9c',
            'CREATES': '#34495e',
            'USES': '#95a5a6',
            'unknown': '#bdc3c7'
        };

        async function loadKnowledgeGraph() {
            try {
                showAutoRefresh();
                
                const response = await fetch('/knowledge-graph/data');
                const data = await response.json();
                
                if (data.success) {
                    graphData = data;
                    initializeGraph();
                    updateGraphStats(data.statistics);
                    createLegend();
                    showAlert('Knowledge graph loaded successfully!', 'success');
                } else {
                    showAlert('Failed to load knowledge graph: ' + data.error, 'error');
                }
                
            } catch (error) {
                console.error('Error loading knowledge graph:', error);
                showAlert('Error loading knowledge graph: ' + error.message, 'error');
            } finally {
                hideAutoRefresh();
            }
        }

        function initializeGraph() {
            if (!graphData || !graphData.entities || !graphData.relationships) {
                showAlert('No graph data available', 'warning');
                return;
            }

            // Show the visualization section
            const kgSection = document.getElementById('kg-visualization-section');
            kgSection.classList.remove('hidden');
            kgSection.classList.add('fade-in');

            // Hide loading message and show SVG
            document.getElementById('kg-graph-loading').style.display = 'none';
            document.getElementById('kg-graph-svg').style.display = 'block';

            // Initialize D3 visualization
            const container = document.getElementById('kg-graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear existing SVG
            d3.select('#kg-graph-svg').selectAll('*').remove();

            svg = d3.select('#kg-graph-svg')
                .attr('width', width)
                .attr('height', height);

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // Create main group for zoomable content
            g = svg.append('g');

            // Create force simulation
            simulation = d3.forceSimulation(graphData.entities)
                .force('link', d3.forceLink(graphData.relationships).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(20));

            // Create links
            const link = g.append('g')
                .attr('class', 'links')
                .selectAll('line')
                .data(graphData.relationships)
                .enter().append('line')
                .attr('class', 'graph-link')
                .attr('stroke', d => linkColors[d.type] || linkColors.unknown)
                .attr('marker-end', 'url(#arrowhead)');

            // Add arrowhead marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 25)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 8)
                .attr('markerHeight', 8)
                .attr('xoverflow', 'visible')
                .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#999')
                .style('stroke', 'none');

            // Create nodes
            const node = g.append('g')
                .attr('class', 'nodes')
                .selectAll('circle')
                .data(graphData.entities)
                .enter().append('circle')
                .attr('class', 'graph-node')
                .attr('r', d => getNodeSize(d.type))
                .attr('fill', d => nodeColors[d.type] || nodeColors.unknown)
                .attr('stroke', '#fff')
                .on('click', handleNodeClick)
                .on('mouseover', handleNodeHover)
                .on('mouseout', handleNodeOut)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add node labels
            const label = g.append('g')
                .attr('class', 'labels')
                .selectAll('text')
                .data(graphData.entities)
                .enter().append('text')
                .attr('class', 'graph-text')
                .text(d => truncateText(d.name, 15))
                .attr('dy', -25);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function getNodeSize(type) {
            const sizes = {
                'class': 12,
                'function': 8,
                'method': 8,
                'test': 10,
                'file': 6,
                'repository': 15,
                'issue': 7,
                'pull_request': 7,
                'commit': 5
            };
            return sizes[type] || 8;
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        function handleNodeClick(event, d) {
            event.stopPropagation();
            
            // Update selected node
            if (selectedNode) {
                d3.selectAll('.graph-node').filter(node => node.id === selectedNode.id).classed('selected', false);
            }
            
            selectedNode = d;
            d3.select(event.target).classed('selected', true);
            
            // Show node details
            showNodeDetails(d);
            
            // Highlight connected nodes and edges
            highlightConnections(d);
        }

        function handleNodeHover(event, d) {
            // Show tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('position', 'absolute')
                .style('background', 'rgba(0,0,0,0.8)')
                .style('color', 'white')
                .style('padding', '8px')
                .style('border-radius', '4px')
                .style('font-size', '12px')
                .style('pointer-events', 'none')
                .style('z-index', '1000')
                .html(`<strong>${d.name}</strong><br>Type: ${d.type}<br>ID: ${d.id}`)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function handleNodeOut(event, d) {
            // Remove tooltip
            d3.selectAll('.tooltip').remove();
        }

        function showNodeDetails(node) {
            const detailsPanel = document.getElementById('node-details');
            const detailsContent = document.getElementById('node-details-content');
            
            let html = `
                <div class="node-detail-item">
                    <span class="node-detail-label">Name:</span> ${node.name}
                </div>
                <div class="node-detail-item">
                    <span class="node-detail-label">Type:</span> ${node.type}
                </div>
                <div class="node-detail-item">
                    <span class="node-detail-label">ID:</span> ${node.id}
                </div>
            `;
            
            if (node.file_path) {
                html += `
                    <div class="node-detail-item">
                        <span class="node-detail-label">File:</span> ${node.file_path}
                    </div>
                `;
            }
            
            if (node.table) {
                html += `
                    <div class="node-detail-item">
                        <span class="node-detail-label">Source:</span> ${node.table}
                    </div>
                `;
            }
            
            detailsContent.innerHTML = html;
            detailsPanel.style.display = 'block';
        }

        function highlightConnections(node) {
            // Reset all highlights
            d3.selectAll('.graph-link').classed('highlighted', false);
            d3.selectAll('.graph-node').style('opacity', 0.3);
            
            // Highlight selected node
            d3.selectAll('.graph-node').filter(d => d.id === node.id).style('opacity', 1);
            
            // Highlight connected nodes and edges
            graphData.relationships.forEach(link => {
                if (link.source.id === node.id || link.target.id === node.id) {
                    // Highlight edge
                    d3.selectAll('.graph-link')
                        .filter(d => d === link)
                        .classed('highlighted', true);
                    
                    // Highlight connected nodes
                    const connectedId = link.source.id === node.id ? link.target.id : link.source.id;
                    d3.selectAll('.graph-node')
                        .filter(d => d.id === connectedId)
                        .style('opacity', 1);
                }
            });
        }

        function resetGraphView() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
            
            // Reset highlights
            d3.selectAll('.graph-link').classed('highlighted', false);
            d3.selectAll('.graph-node').style('opacity', 1).classed('selected', false);
            
            // Hide node details
            document.getElementById('node-details').style.display = 'none';
            selectedNode = null;
            
            // Reset zoom
            if (svg) {
                svg.transition().duration(750).call(
                    d3.zoom().transform,
                    d3.zoomIdentity
                );
            }
        }

        function updateGraphStats(stats) {
            document.getElementById('total-nodes-stat').textContent = stats.total_nodes || 0;
            document.getElementById('total-edges-stat').textContent = stats.total_relationships || 0;
            document.getElementById('node-types-stat').textContent = stats.node_types || 0;
            document.getElementById('edge-types-stat').textContent = stats.relationship_types || 0;
            
            document.getElementById('graph-stats').style.display = 'flex';
        }

        function createLegend() {
            const nodeLegend = document.getElementById('node-legend');
            const relationshipLegend = document.getElementById('relationship-legend');
            
            // Create node type legend
            const nodeTypes = [...new Set(graphData.entities.map(e => e.type))];
            nodeLegend.innerHTML = '';
            nodeTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${nodeColors[type] || nodeColors.unknown}"></div>
                    <span>${type}</span>
                `;
                nodeLegend.appendChild(item);
            });
            
            // Create relationship type legend
            const relationshipTypes = [...new Set(graphData.relationships.map(r => r.type))];
            relationshipLegend.innerHTML = '';
            relationshipTypes.forEach(type => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `
                    <div class="legend-color" style="background-color: ${linkColors[type] || linkColors.unknown}"></div>
                    <span>${type}</span>
                `;
                relationshipLegend.appendChild(item);
            });
        }

        function toggleGraphLegend() {
            const legend = document.getElementById('graph-legend');
            legend.style.display = legend.style.display === 'none' ? 'block' : 'none';
        }

        function filterNodes() {
            const filter = document.getElementById('node-filter').value;
            
            if (!graphData) return;
            
            d3.selectAll('.graph-node').style('display', d => {
                return filter === 'all' || d.type === filter ? 'block' : 'none';
            });
            
            d3.selectAll('.graph-text').style('display', d => {
                return filter === 'all' || d.type === filter ? 'block' : 'none';
            });
        }

        function filterRelationships() {
            const filter = document.getElementById('relationship-filter').value;
            
            if (!graphData) return;
            
            d3.selectAll('.graph-link').style('display', d => {
                return filter === 'all' || d.type === filter ? 'block' : 'none';
            });
        }

        function changeGraphLayout() {
            const layout = document.getElementById('graph-layout').value;
            
            if (!simulation || !graphData) return;
            
            // Stop current simulation
            simulation.stop();
            
            // Apply new layout
            switch (layout) {
                case 'hierarchical':
                    applyHierarchicalLayout();
                    break;
                case 'circular':
                    applyCircularLayout();
                    break;
                default:
                    applyForceLayout();
            }
        }

        function applyForceLayout() {
            const container = document.getElementById('kg-graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            simulation = d3.forceSimulation(graphData.entities)
                .force('link', d3.forceLink(graphData.relationships).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(20));
                
            simulation.on('tick', updatePositions);
            simulation.alpha(1).restart();
        }

        function applyHierarchicalLayout() {
            // Simple hierarchical layout based on node types
            const container = document.getElementById('kg-graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const typeOrder = ['repository', 'file', 'class', 'function', 'method', 'test'];
            const levelHeight = height / typeOrder.length;
            
            graphData.entities.forEach((node, i) => {
                const typeIndex = typeOrder.indexOf(node.type);
                const level = typeIndex >= 0 ? typeIndex : typeOrder.length - 1;
                
                node.fx = (i % 10) * (width / 10) + 50;
                node.fy = level * levelHeight + levelHeight / 2;
            });
            
            simulation.alpha(1).restart();
        }

        function applyCircularLayout() {
            const container = document.getElementById('kg-graph-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 3;
            
            graphData.entities.forEach((node, i) => {
                const angle = (i / graphData.entities.length) * 2 * Math.PI;
                node.fx = centerX + radius * Math.cos(angle);
                node.fy = centerY + radius * Math.sin(angle);
            });
            
            simulation.alpha(1).restart();
        }

        function updatePositions() {
            d3.selectAll('.graph-link')
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            d3.selectAll('.graph-node')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            d3.selectAll('.graph-text')
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        }

        function exportGraphData() {
            if (!graphData) {
                showAlert('No graph data to export', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(graphData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'knowledge-graph-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('Graph data exported successfully!', 'success');
        }

        // Drag functions for D3
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Show knowledge graph section when status is loaded
        function showKnowledgeGraphSection() {
            const kgSection = document.getElementById('kg-visualization-section');
            kgSection.classList.remove('hidden');
            kgSection.classList.add('fade-in');
        }
    </script>
</body>
</html>